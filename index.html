<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HONGHAC. BUILDA - Key Verification</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        /* --- RESET & BASIC SETUP --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Montserrat', sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(-45deg, #0f0c29, #302b63, #24243e, #141E30);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: #fff;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- CARD CONTAINER --- */
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px 30px;
            width: 90%;
            max-width: 450px;
            text-align: center;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        /* --- BRAND TITLE --- */
        .brand-title {
            font-weight: 800;
            font-size: 1.8rem;
            letter-spacing: 2px;
            margin-bottom: 25px;
            text-transform: uppercase;
            background: linear-gradient(to right, #00c6ff, #0072ff, #00c6ff);
            background-size: 200% auto;
            color: #fff;
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shine 3s linear infinite;
            position: relative;
        }
        .brand-title::after {
            content: ''; position: absolute; left: 50%; bottom: -10px;
            transform: translateX(-50%); width: 50px; height: 3px;
            background: #0072ff; border-radius: 2px; box-shadow: 0 0 10px #0072ff;
        }
        @keyframes shine { to { background-position: 200% center; } }

        /* --- CONTENT STYLES --- */
        .status-icon { font-size: 4rem; margin-bottom: 15px; transition: all 0.3s ease; }
        .result-title { font-size: 1.4rem; font-weight: 600; margin-bottom: 10px; }
        .result-msg { font-size: 0.9rem; color: rgba(255, 255, 255, 0.7); margin-bottom: 25px; line-height: 1.5; }
        .valid { color: #00ff88; text-shadow: 0 0 15px rgba(0, 255, 136, 0.4); }
        .expired { color: #ff4b2b; text-shadow: 0 0 15px rgba(255, 75, 43, 0.4); }
        .error { color: #ffcc00; }

        /* --- BUTTONS --- */
        .action-btn {
            background: linear-gradient(90deg, #00c6ff, #0072ff);
            border: none; color: white; padding: 12px 30px;
            border-radius: 30px; cursor: pointer; font-weight: 700;
            font-size: 1rem; margin-top: 10px;
            box-shadow: 0 4px 15px rgba(0, 114, 255, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }
        .action-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 198, 255, 0.6); }
        .action-btn:active { transform: scale(0.95); }
        .action-btn:disabled { background: #555; cursor: not-allowed; box-shadow: none; transform: none; opacity: 0.7; }

        /* --- KEY BOX --- */
        .key-box {
            background: rgba(0, 0, 0, 0.3);
            border: 1px dashed rgba(255, 255, 255, 0.3);
            border-radius: 10px; padding: 15px; margin-bottom: 20px;
            position: relative; display: flex; align-items: center; justify-content: space-between;
        }
        .key-text {
            font-family: 'Consolas', monospace; font-size: 1.1rem; color: #fff;
            letter-spacing: 1px; word-break: break-all; text-align: left; flex-grow: 1;
        }
        .copy-btn {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer;
            font-weight: 600; font-size: 0.75rem; margin-left: 10px; transition: all 0.2s;
        }
        .copy-btn:hover { background: rgba(255,255,255,0.2); }

        /* --- LOADER & STEPS --- */
        .loader-ring {
            display: inline-block; width: 50px; height: 50px;
        }
        .loader-ring:after {
            content: " "; display: block; width: 40px; height: 40px; margin: 5px;
            border-radius: 50%; border: 4px solid #fff;
            border-color: #fff transparent #fff transparent;
            animation: ring 1.2s linear infinite;
        }
        @keyframes ring { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .timer-badge {
            display: inline-block; background: rgba(255, 255, 255, 0.1);
            padding: 5px 15px; border-radius: 20px; font-size: 0.85rem; color: #a8c0ff; margin-top: 10px;
        }

        .step-progress {
            margin-top: 15px; font-size: 0.85rem; color: #aaa; font-style: italic;
        }

        /* MOBILE */
        @media (max-width: 480px) {
            .brand-title { font-size: 1.5rem; }
            .glass-card { padding: 30px 20px; }
        }
    </style>
</head>

<body>

    <div class="glass-card">
        <div class="brand-title">HONGHAC. BUILDA</div>

        <div id="start-screen">
            <div style="margin-bottom: 20px;">
                <i class="fas fa-shield-alt" style="font-size: 3.5rem; color: #00c6ff; margin-bottom: 15px;"></i>
                <p class="result-msg" style="margin-bottom: 10px;">Hệ thống xác thực Key tự động</p>
                <p style="font-size: 0.8rem; color: #888;">Nhấn nút bên dưới để bắt đầu lấy Key.</p>
            </div>
            <button id="btn-get-key" class="action-btn" onclick="startProcess()">
                <i class="fas fa-key"></i> LẤY KEY NGAY
            </button>
        </div>

        <div id="loader" style="display: none;">
            <div class="loader-ring"></div>
            <p id="loader-text" style="margin-top: 15px; font-size: 0.95rem; font-weight: 600;">Đang khởi tạo...</p>
            <div class="step-progress" id="step-text">Bước 1/3: Kiểm tra trình duyệt...</div>
        </div>

        <div id="content" style="display: none;">
            <div id="icon-area"></div>
            <div class="result-title" id="status-title">Kết quả</div>
            <p class="result-msg" id="status-msg">...</p>

            <div id="key-area" style="display: none;">
                <div class="key-box">
                    <span class="key-text" id="key-text">LOADING...</span>
                    <button class="copy-btn" onclick="copyKey()">COPY</button>
                </div>
                <div class="timer-badge">
                    <i class="far fa-clock"></i> <span id="timer-text">--:--</span>
                </div>
                <div style="margin-top: 20px;">
                     <a href="javascript:location.reload()" style="color: #00c6ff; text-decoration: none; font-size: 0.8rem;">
                        <i class="fas fa-sync"></i> Làm mới trang
                     </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
        // --- 1. CONFIG FIREBASE ---
        const firebaseConfig = {
            projectId: 'honghac-builda-keys',
            apiKey: 'AIzaSyCsR_yDVQGgeqJAp5NvLWeLkPgz0scN-Xw',
            databaseURL: 'https://honghac-builda-keys-default-rtdb.asia-southeast1.firebasedatabase.app'
        };

        const COOLDOWN_SECONDS = 60; 
        
        // --- QUAN TRỌNG: Tăng lên 500 để quét sâu qua các key đã hết hạn ---
        // Với tốc độ 120 key/h, 500 key sẽ quét được khoảng 4 tiếng dữ liệu gần nhất.
        const SEARCH_LIMIT = 500;    

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- 2. LOGIC START PROCESS (GIỮ NGUYÊN) ---
        async function startProcess() {
            const btn = document.getElementById('btn-get-key');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> ĐANG TÌM...';

            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('loader').style.display = 'block';

            const stepText = document.getElementById('step-text');
            const loadText = document.getElementById('loader-text');

            // Giữ hiệu ứng chờ 3 bước để chặn spam
            loadText.innerText = "Đang kết nối kho dữ liệu...";
            stepText.innerText = "Bước 1/3: Xác thực người dùng...";
            await new Promise(r => setTimeout(r, 1000));

            loadText.innerText = "Đang lọc key rác...";
            stepText.innerText = "Bước 2/3: Đang tìm key còn hạn...";
            await new Promise(r => setTimeout(r, 1500));

            loadText.innerText = "Đang lấy dữ liệu...";
            stepText.innerText = "Bước 3/3: Hoàn tất...";
            
            autoGetKey(); // Gọi hàm lấy key
        }

        // --- 3. LOGIC CHECK KEY (GIỮ NGUYÊN) ---
        async function checkKey() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('loader').style.display = 'block';
            document.getElementById('loader-text').innerText = "Đang kiểm tra Key...";
            document.getElementById('step-text').style.display = 'none';

            const urlParams = new URLSearchParams(window.location.search);
            let keyId = urlParams.get('key') || urlParams.get('keys') || urlParams.get('k');
            if (typeof keyId === 'string') keyId = keyId.trim();

            await new Promise(r => setTimeout(r, 500));

            if (!keyId) {
                renderResult('error', 'LỖI', 'Vui lòng nhấn nút Lấy Key.');
                return;
            }

            try {
                const docRef = db.collection("keys").doc(keyId);
                const docSnap = await docRef.get();

                if (!docSnap.exists) { renderResult('error', 'KHÔNG TỒN TẠI', 'Key không đúng.'); return; }
                const data = docSnap.data() || {};
                
                if (data.used === true) { renderResult('error', 'ĐÃ SỬ DỤNG', 'Key đã bị hủy.'); return; }

                const now = Math.floor(Date.now() / 1000);
                const expires = Number(data.expires_seconds) || 3600;

                let activatedAt = Number(data.activated_at) || 0;
                if (activatedAt > now * 10) activatedAt = Math.floor(activatedAt / 1000);

                if (!activatedAt) {
                    renderResult('valid', 'ĐANG KÍCH HOẠT', 'Đang kích hoạt key...');
                    const res = await activateKeyAtomic(keyId);
                    if (res.ok) showSuccess(keyId, expires);
                    else setTimeout(() => location.reload(), 1000);
                    return;
                }

                const timeLeft = (activatedAt + expires) - now;
                if (timeLeft <= 0) { renderResult('expired', 'HẾT HẠN', 'Key này đã hết hạn.'); return; }

                // Check cooldown last_used
                let lastUsed = Number(data.last_used) || 0;
                if (lastUsed > now * 10) lastUsed = Math.floor(lastUsed / 1000);
                if (lastUsed && (now - lastUsed < COOLDOWN_SECONDS)) {
                    renderResult('error', 'CHỜ CHÚT', `Vui lòng đợi ${COOLDOWN_SECONDS - (now - lastUsed)}s.`);
                    return;
                }

                const mark = await markKeyAsUsedAtomic(keyId);
                if (mark.ok) showSuccess(keyId, timeLeft);
                else renderResult('error', 'LỖI', 'Key đang bận hoặc lỗi mạng.');

            } catch (error) { renderResult('error', 'LỖI MẠNG', 'Kiểm tra kết nối.'); }
        }

        // --- 4. LOGIC AUTO GET KEY (ĐÃ TỐI ƯU CHO SỐ LƯỢNG LỚN) ---
        async function autoGetKey() {
            try {
                // Tăng limit để quét sâu hơn
                const q = await db.collection('keys')
                            .where('used', '==', false)
                            .limit(SEARCH_LIMIT) 
                            .get();
                            
                const docs = (q && q.docs) ? q.docs.slice() : [];
                
                if (!docs.length) {
                    renderResult('error', 'HẾT KEY', 'Kho đang trống, admin chưa nạp key.');
                    return;
                }

                const now = Math.floor(Date.now() / 1000);
                
                // Xáo trộn danh sách để user không tranh nhau cùng 1 key đầu tiên
                // Điều này cực quan trọng khi nhiều người bấm cùng lúc
                const order = docs.map((_, i) => i).sort(() => Math.random() - 0.5);

                for (let idx of order) {
                    const doc = docs[idx];
                    const id = doc.id;
                    const data = doc.data() || {};
                    const link = data.steplink1 || data.short_link || data.shortlink; // Ưu tiên steplink1
                    
                    if (!link) continue;

                    const expires = Number(data.expires_seconds) || 3600; 
                    let activatedAt = Number(data.activated_at) || 0;
                    if (activatedAt > now * 10) activatedAt = Math.floor(activatedAt / 1000);

                    // --- BỘ LỌC THÔNG MINH ---
                    // 1. Nếu đã kích hoạt và hết hạn -> Bỏ qua ngay (Không báo lỗi)
                    if (activatedAt && (activatedAt + expires <= now)) continue;

                    // 2. Nếu vừa có người dùng xong (Cooldown) -> Bỏ qua
                    let lastUsed = Number(data.last_used) || 0;
                    if (lastUsed > now * 10) lastUsed = Math.floor(lastUsed / 1000);
                    if (lastUsed && (now - lastUsed < COOLDOWN_SECONDS)) continue;

                    // --- TÌM THẤY KEY NGON ---
                    if (!activatedAt) {
                        // Key chưa kích hoạt -> Ăn ngay
                        const res = await activateKeyAtomic(id);
                        if (res.ok) { redirectToKey(link, expires); return; }
                    } else {
                        // Key cũ còn hạn -> Dùng tiếp
                        const mark = await markKeyAsUsedAtomic(id);
                        if (mark.ok) {
                            redirectToKey(link, (activatedAt + expires) - now);
                            return;
                        }
                    }
                }

                // Nếu quét hết 500 key mà vẫn không tìm được cái nào
                renderResult('error', 'HẾT KEY', 'Đã quét 500 key nhưng đều hết hạn. Vui lòng báo Admin reset.');

            } catch (e) {
                console.error(e);
                renderResult('error', 'LỖI SERVER', 'Không thể lấy danh sách key.');
            }
        }

        // --- CÁC HÀM PHỤ TRỢ (GIỮ NGUYÊN) ---
        function redirectToKey(link, timeLeft) {
            renderResult('valid', 'THÀNH CÔNG', 'Đang chuyển hướng...');
            document.getElementById('key-area').style.display = 'block';
            document.getElementById('key-text').innerText = link;
            let mins = Math.ceil(timeLeft / 60);
            document.getElementById('timer-text').innerText = `Hạn dùng: ${mins} phút`;
            setTimeout(() => window.open(link, '_blank'), 1500);
        }

        function showSuccess(keyText, timeLeft) {
            renderResult('valid', 'KEY HỢP LỆ', 'Copy key bên dưới:');
            document.getElementById('key-area').style.display = 'block';
            document.getElementById('key-text').innerText = keyText;
            document.getElementById('timer-text').innerText = `Còn lại: ${Math.ceil(timeLeft / 60)} phút`;
        }

        // Transaction an toàn (Chống hack/trùng lặp)
        async function activateKeyAtomic(keyId) {
            const docRef = db.collection('keys').doc(keyId);
            try {
                await db.runTransaction(async (tx) => {
                    const snap = await tx.get(docRef);
                    if(!snap.exists) throw "Err";
                    const d = snap.data();
                    if(d.activated_at) throw "Activated";
                    if(d.used === true) throw "Used";
                    const now = Math.floor(Date.now()/1000);
                    tx.update(docRef, { activated_at: now, last_used: now });
                });
                return {ok: true};
            } catch(e) { return {ok: false, error: e}; }
        }

        async function markKeyAsUsedAtomic(keyId) {
            const docRef = db.collection('keys').doc(keyId);
            try {
                await db.runTransaction(async (tx) => {
                    const snap = await tx.get(docRef);
                    const d = snap.data();
                    const now = Math.floor(Date.now()/1000);
                    let act = Number(d.activated_at)||0;
                    if(act > now*10) act = Math.floor(act/1000);
                    
                    if(!act) throw "NotAct";
                    if(act + (Number(d.expires_seconds)||3600) <= now) throw "Expired";
                    
                    let last = Number(d.last_used)||0;
                    if(last > now*10) last = Math.floor(last/1000);
                    if(last && (now - last < COOLDOWN_SECONDS)) throw "Cooldown";

                    tx.update(docRef, { last_used: now });
                });
                return {ok: true};
            } catch(e) { return {ok: false, error: e}; }
        }

        function renderResult(type, title, msg) {
            document.getElementById('loader').style.display = 'none';
            const c = document.getElementById('content');
            c.style.display = 'block';
            c.style.animation = "popIn 0.5s ease";
            
            const i = document.getElementById('icon-area');
            const t = document.getElementById('status-title');
            const m = document.getElementById('status-msg');
            t.innerText = title; m.innerText = msg;

            if(type==='valid') { i.innerHTML='<i class="fas fa-check-circle status-icon valid"></i>'; t.style.color='#00ff88'; }
            else if(type==='expired') { i.innerHTML='<i class="fas fa-times-circle status-icon expired"></i>'; t.style.color='#ff4b2b'; }
            else { i.innerHTML='<i class="fas fa-exclamation-triangle status-icon error"></i>'; t.style.color='#ffcc00'; }
        }

        function copyKey() {
            navigator.clipboard.writeText(document.getElementById('key-text').innerText).then(() => {
                const b = document.querySelector('.copy-btn');
                b.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(() => b.innerHTML = 'COPY', 2000);
            });
        }

        window.onload = function() {
            const p = new URLSearchParams(location.search);
            if(p.get('key')||p.get('keys')||p.get('k')) checkKey();
            else document.getElementById('start-screen').style.display = 'block';
        }
    </script>
</body>
</html>
